# Scaling

## ELB Precisions

It expose a **single point of access**.  
**Health checks** are a way to verify if an instance is available. Uses **a port and a route**.  
They can be private or public.  

## ALB Precisions

It supports load balancing to **multiple applications in the same machine**.   
They can route to **multiple target groups**.    
It has a **fixed hostname**  
*Reminder: ALB is for HTTP / HTTPs (Stateless) and Websocket (Stateful).*

Routing rules are:
- The **path in the URL** *(test.com/users...)*
- The **host header name** *(ok.test.com, okok.test.com...)*
- The **http request method** *(GET, POST...)*
- The **query strings** *(?id=123&order=false)*
- The **http headers** *(Content-Type...)*

You can define a priority, when multiples rules are matches the highest priority will win.  
Client IP is forwarded in **X-Forwarded-For** header.

*Note: Launch configuration CANNOT be changed!*

### Target groups

- **EC2 Instances**
- **ECS Tasks**
- **Lambda functions**
- **IP Addresses**, must be private

## NLB Precisions

It can handle **millions of requests per seconds**.  
NLB has **one static IP per AZ**, and supports Elastic IP.  

Healths checks supports TCP, HTTP and HTTPS protocols.

### Target goups

- **EC2 instances**
- **Target Group**
- **An ALB** (if you need a static IP)

## GLB Precisions

Used to redirect traffic to **firewalls, intruser detection systems...**  
It balance the networks to multiple EC2 instances that analyzes packets.  
They will **send back** the packets **or drop it**.  
If the trafic is sent back, the GLB will redirect it **to the application**.  

### Target groups

- **EC2 Instances**
- **IP Addresses**

## Sticky Sessions

A client doing different requests to the ELB will be **redirected to the same instance**.  
It works with a cookie on ALB. But it may **lead to imbalances**.  
**Use case:** Keep user session data.

Cookie types:
- **Application-based: Custom cookie**
  - Generated by the **target**  
  - Can include other **custom attributes** needed by the application
  - Cookie name must be specified **individually** for each target group.
  - Don't use **AWSALB, AWSALBAPP, AWSALBTG** (reserved)
- **Application-based: Application cookie**
  - Generated **by the ALB**
  - Name is **AWSALBAPP**
- **Duration-based Cookies**
  - Generated by the **load balances**
  - Cookie **name is AWSALB** for ALB and **AWSELB** for CLB
  - Expiration defined by the ELB

## Cross-zone Load Balancing

Will balance the traffic evenly accross **all** instances.  
Without it, the traffic will be evenly **divided accross AZ** and distributed accross instances, **but not evenly**.  
It is **always on for ALBs**, you can disable it on target groups.

Will cause **charges for inter-AZ data transfer** on NLBs and GLBs.

## SSL on ELBs

Load balancer uses an **X.509 certificate** (SSL/TLS server certificate)  
Certificates are managed by *AWS Certificate Manager** (ACM).  
You can upload **your own certificates**.  
You must specify a default certificate and add **an optional list of certs to support multiple domains**.  
Clients can use **SNI (server name indication) to specify the hostname they reach**. *(not supported by CLB)*

## Deregistration Delay / Connection Draining

It will give instances some time to **complete in-flight requests while the instance is de-registering**.  
And il will **stop sending new requests to the EC2 that is de-registering**.  
Between **1s to 1h**, you can disable it. Low value = short requests.  

## ASG Launch Templates

**Contains the configuration** when generating an EC2 instance in an ASG.

## CloudWatch based ASG scaling

We can use **CloudWatch alarms to scale in/out ASGs**.

## Good Metrics to Scale on

- **CPU Usage**
- **Request count per target**
- **Average network in/out**

## ASG Scaling Cooldown

After a scaling happens **there is a cooldown period** (default 300 seconds).  
During the cooldown, **no instances are going to be terminated / launched**.  

## ASG Termination Policy

- **Check the AZ with the most instances**
- **Priorities Spot Instances over On Demand**
- **Launch Template:** If no launch configuration kill the older launch template
- **Launch Configuration:** Kill the older launch configuration
- If there's still multiple EC2 instances, kill the one **closest to the next billing hour**.

## Instance Impaired Status

When an **AWS-side issue occur on an instance**.  
ASG Does not immediately terminate instances with an **Impaired Status**.  
It waits a few minutes for the instance to recover.

## Spot Fleet

A group of **EC2 spot instances**.

## Spot Block

A **reserved spot instance for 1 to 6 hours**.
